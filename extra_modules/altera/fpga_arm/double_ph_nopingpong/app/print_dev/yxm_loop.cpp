#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/mman.h>
#include <errno.h>
#include <string.h>
#include <time.h>
#include <sys/time.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <sys/ioctl.h>


#include "alt_f2sm_regs.h"
#include "YxmIntf.h"

#define likely(x)	__builtin_expect(!!(x), 1)
#define unlikely(x)	__builtin_expect(!!(x), 0)

#define TEST_TIMES 10

#define HPS_FPGA_BRIDGE_BASE 0xFF200000

struct f2sm_read_info_t {
	u_int32_t irq_count;
	int mem_index;
};

#define TEST_BLOCK_SIZE (3*1024)
#define TEST_BLOCK_CNT 1024

#define PH1_USERBUF_OFFSET 	(12*1024*1024)

typedef unsigned char u8;
typedef unsigned short u16;
typedef unsigned int u32;

static int build_fpga_data(void *ph0_data, void *ph1_data, u32 block_size, u32 block_cnt)
{
	u8 *buf_ph0 = (u8 *)ph0_data;
	u8 *buf_ph1 = (u8 *)ph1_data;

	/* check size */
	if (block_size != TEST_BLOCK_SIZE) {
		fprintf(stderr, "Block Size Error at line %d, file %s\n", __LINE__, __FILE__);
		return -1;
	}

	/* build data */
	u8 row;
	u8 line;
	u32 block;
	for (block = 0; block < block_cnt; block++) {
		for (row = 0; row < 192; row++) {
			for (line = 0; line < 16; line++) {
				*buf_ph0++ = row; 
				*buf_ph1++ = (line & 0xf) | (((u8)block << 4) & 0xf0);
			}
		}
	}
	
	return 0;
}

static int check_fpga_data(void *ph0_data, void *ph1_data, u32 block_size, u32 block_cnt)
{
	u8 *buf_ph0 = (u8 *)ph0_data;
	u8 *buf_ph1 = (u8 *)ph1_data;

	/* check size */
	if (block_size != TEST_BLOCK_SIZE) {
		fprintf(stderr, "Block Size Error at line %d, file %s\n", __LINE__, __FILE__);
		return -1;
	}

	/* check data */
	u8 row;
	u8 line;
	u32 block;
	for (block = 0; block < block_cnt; block++) {
		for (row = 0; row < 192; row++) {
			for (line = 0; line < 16; line++) {
				if ((*buf_ph0 != row) && (*buf_ph1 != (line & 0xf) | (((u8)block << 4) & 0xf0))) {
					fprintf(stderr, "check data Error at line %d, file %s\n", __LINE__, __FILE__);
					return -1;
				}
				buf_ph0++; 
				buf_ph1++;
			}
		}
	}	

	return 0;
}


static u8 a_unit1_s1[664] = { 0,82,6,82,3,82,5,82,1,82,7,82,2,82,4,82, \
							  0,81,6,81,3,81,5,81,1,81,7,81,2,81,4,81, \
							  0,80,6,80,3,80,5,80,1,80,7,80,2,80,4,80, \
							  0,79,6,79,3,79,5,79,1,79,7,79,2,79,4,79, \
							  0,78,6,78,3,78,5,78,1,78,7,78,2,78,4,78, \
							  0,77,6,77,3,77,5,77,1,77,7,77,2,77,4,77, \
							  0,76,6,76,3,76,5,76,1,76,7,76,2,76,4,76, \
							  0,75,6,75,3,75,5,75,1,75,7,75,2,75,4,75, \
							  0,74,6,74,3,74,5,74,1,74,7,74,2,74,4,74, \
							  0,73,6,73,3,73,5,73,1,73,7,73,2,73,4,73, \
							  0,72,6,72,3,72,5,72,1,72,7,72,2,72,4,72, \
							  0,71,6,71,3,71,5,71,1,71,7,71,2,71,4,71, \
							  0,70,6,70,3,70,5,70,1,70,7,70,2,70,4,70, \
							  0,69,6,69,3,69,5,69,1,69,7,69,2,69,4,69, \
							  0,68,6,68,3,68,5,68,1,68,7,68,2,68,4,68, \
							  0,67,6,67,3,67,5,67,1,67,7,67,2,67,4,67, \
							  0,66,6,66,3,66,5,66,1,66,7,66,2,66,4,66, \
							  0,65,6,65,3,65,5,65,1,65,7,65,2,65,4,65, \
							  0,64,6,64,3,64,5,64,1,64,7,64,2,64,4,64, \
							  0,63,6,63,3,63,5,63,1,63,7,63,2,63,4,63, \
							  0,62,6,62,3,62,5,62,1,62,7,62,2,62,4,62, \
							  0,61,6,61,3,61,5,61,1,61,7,61,2,61,4,61, \
							  0,60,6,60,3,60,5,60,1,60,7,60,2,60,4,60, \
							  0,59,6,59,3,59,5,59,1,59,7,59,2,59,4,59, \
							  0,58,6,58,3,58,5,58,1,58,7,58,2,58,4,58, \
							  0,57,6,57,3,57,5,57,1,57,7,57,2,57,4,57, \
							  0,56,6,56,3,56,5,56,1,56,7,56,2,56,4,56, \
							  0,55,6,55,3,55,5,55,1,55,7,55,2,55,4,55, \
							  0,54,6,54,3,54,5,54,1,54,7,54,2,54,4,54, \
							  0,53,6,53,3,53,5,53,1,53,7,53,2,53,4,53, \
							  0,52,6,52,3,52,5,52,1,52,7,52,2,52,4,52, \
							  0,51,6,51,3,51,5,51,1,51,7,51,2,51,4,51, \
							  0,50,6,50,3,50,5,50,1,50,7,50,2,50,4,50, \
							  0,49,6,49,3,49,5,49,1,49,7,49,2,49,4,49, \
							  0,48,6,48,3,48,5,48,1,48,7,48,2,48,4,48, \
							  0,47,6,47,3,47,5,47,1,47,7,47,2,47,4,47, \
							  0,46,6,46,3,46,5,46,1,46,7,46,2,46,4,46, \
							  0,45,6,45,3,45,5,45,1,45,7,45,2,45,4,45, \
							  0,44,6,44,3,44,5,44,1,44,7,44,2,44,4,44, \
							  0,43,6,43,3,43,5,43,1,43,7,43,2,43,4,43, \
							  0,42,6,42,3,42,5,42,1,42,7,42,2,42,4,42, \
							  0,41,6,41,3,41,5,41
							};

static u8 a_unit1_s2[664] = { 1,41,7,41,2,41,4,41, \
							  0,40,6,40,3,40,5,40,1,40,7,40,2,40,4,40, \
							  0,39,6,39,3,39,5,39,1,39,7,39,2,39,4,39, \
							  0,38,6,38,3,38,5,38,1,38,7,38,2,38,4,38, \
							  0,37,6,37,3,37,5,37,1,37,7,37,2,37,4,37, \
							  0,36,6,36,3,36,5,36,1,36,7,36,2,36,4,36, \
							  0,35,6,35,3,35,5,35,1,35,7,35,2,35,4,35, \
							  0,34,6,34,3,34,5,34,1,34,7,34,2,34,4,34, \
							  0,33,6,33,3,33,5,33,1,33,7,33,2,33,4,33, \
							  0,32,6,32,3,32,5,32,1,32,7,32,2,32,4,32, \
							  0,31,6,31,3,31,5,31,1,31,7,31,2,31,4,31, \
							  0,30,6,30,3,30,5,30,1,30,7,30,2,30,4,30, \
							  0,29,6,29,3,29,5,29,1,29,7,29,2,29,4,29, \
							  0,28,6,28,3,28,5,28,1,28,7,28,2,28,4,28, \
							  0,27,6,27,3,27,5,27,1,27,7,27,2,27,4,27, \
							  0,26,6,26,3,26,5,26,1,26,7,26,2,26,4,26, \
							  0,25,6,25,3,25,5,25,1,25,7,25,2,25,4,25, \
							  0,24,6,24,3,24,5,24,1,24,7,24,2,24,4,24, \
							  0,23,6,23,3,23,5,23,1,23,7,23,2,23,4,23, \
							  0,22,6,22,3,22,5,22,1,22,7,22,2,22,4,22, \
							  0,21,6,21,3,21,5,21,1,21,7,21,2,21,4,21, \
							  0,20,6,20,3,20,5,20,1,20,7,20,2,20,4,20, \
							  0,19,6,19,3,19,5,19,1,19,7,19,2,19,4,19, \
							  0,18,6,18,3,18,5,18,1,18,7,18,2,18,4,18, \
							  0,17,6,17,3,17,5,17,1,17,7,17,2,17,4,17, \
							  0,16,6,16,3,16,5,16,1,16,7,16,2,16,4,16, \
							  0,15,6,15,3,15,5,15,1,15,7,15,2,15,4,15, \
							  0,14,6,14,3,14,5,14,1,14,7,14,2,14,4,14, \
							  0,13,6,13,3,13,5,13,1,13,7,13,2,13,4,13, \
							  0,12,6,12,3,12,5,12,1,12,7,12,2,12,4,12, \
							  0,11,6,11,3,11,5,11,1,11,7,11,2,11,4,11, \
							  0,10,6,10,3,10,5,10,1,10,7,10,2,10,4,10, \
							  0,9,6,9,3,9,5,9,1,9,7,9,2,9,4,9, \
							  0,8,6,8,3,8,5,8,1,8,7,8,2,8,4,8, \
							  0,7,6,7,3,7,5,7,1,7,7,7,2,7,4,7, \
							  0,6,6,6,3,6,5,6,1,6,7,6,2,6,4,6, \
							  0,5,6,5,3,5,5,5,1,5,7,5,2,5,4,5, \
							  0,4,6,4,3,4,5,4,1,4,7,4,2,4,4,4, \
							  0,3,6,3,3,3,5,3,1,3,7,3,2,3,4,3, \
							  0,2,6,2,3,2,5,2,1,2,7,2,2,2,4,2, \
							  0,1,6,1,3,1,5,1,1,1,7,1,2,1,4,1, \
							  0,0,6,0,3,0,5,0,1,0,7,0,2,0,4,0
							};

static u8 a_unit2_s1[664] = { 0,165,6,165,3,165,5,165,1,165,7,165,2,165,4,165, \
							  0,164,6,164,3,164,5,164,1,164,7,164,2,164,4,164, \
							  0,163,6,163,3,163,5,163,1,163,7,163,2,163,4,163, \
							  0,162,6,162,3,162,5,162,1,162,7,162,2,162,4,162, \
							  0,161,6,161,3,161,5,161,1,161,7,161,2,161,4,161, \
							  0,160,6,160,3,160,5,160,1,160,7,160,2,160,4,160, \
							  0,159,6,159,3,159,5,159,1,159,7,159,2,159,4,159, \
							  0,158,6,158,3,158,5,158,1,158,7,158,2,158,4,158, \
							  0,157,6,157,3,157,5,157,1,157,7,157,2,157,4,157, \
							  0,156,6,156,3,156,5,156,1,156,7,156,2,156,4,156, \
							  0,155,6,155,3,155,5,155,1,155,7,155,2,155,4,155, \
							  0,154,6,154,3,154,5,154,1,154,7,154,2,154,4,154, \
							  0,153,6,153,3,153,5,153,1,153,7,153,2,153,4,153, \
							  0,152,6,152,3,152,5,152,1,152,7,152,2,152,4,152, \
							  0,151,6,151,3,151,5,151,1,151,7,151,2,151,4,151, \
							  0,150,6,150,3,150,5,150,1,150,7,150,2,150,4,150, \
							  0,149,6,149,3,149,5,149,1,149,7,149,2,149,4,149, \
							  0,148,6,148,3,148,5,148,1,148,7,148,2,148,4,148, \
							  0,147,6,147,3,147,5,147,1,147,7,147,2,147,4,147, \
							  0,146,6,146,3,146,5,146,1,146,7,146,2,146,4,146, \
							  0,145,6,145,3,145,5,145,1,145,7,145,2,145,4,145, \
							  0,144,6,144,3,144,5,144,1,144,7,144,2,144,4,144, \
							  0,143,6,143,3,143,5,143,1,143,7,143,2,143,4,143, \
							  0,142,6,142,3,142,5,142,1,142,7,142,2,142,4,142, \
							  0,141,6,141,3,141,5,141,1,141,7,141,2,141,4,141, \
							  0,140,6,140,3,140,5,140,1,140,7,140,2,140,4,140, \
							  0,139,6,139,3,139,5,139,1,139,7,139,2,139,4,139, \
							  0,138,6,138,3,138,5,138,1,138,7,138,2,138,4,138, \
							  0,137,6,137,3,137,5,137,1,137,7,137,2,137,4,137, \
							  0,136,6,136,3,136,5,136,1,136,7,136,2,136,4,136, \
							  0,135,6,135,3,135,5,135,1,135,7,135,2,135,4,135, \
							  0,134,6,134,3,134,5,134,1,134,7,134,2,134,4,134, \
							  0,133,6,133,3,133,5,133,1,133,7,133,2,133,4,133, \
							  0,132,6,132,3,132,5,132,1,132,7,132,2,132,4,132, \
							  0,131,6,131,3,131,5,131,1,131,7,131,2,131,4,131, \
							  0,130,6,130,3,130,5,130,1,130,7,130,2,130,4,130, \
							  0,129,6,129,3,129,5,129,1,129,7,129,2,129,4,129, \
							  0,128,6,128,3,128,5,128,1,128,7,128,2,128,4,128, \
							  0,127,6,127,3,127,5,127,1,127,7,127,2,127,4,127, \
							  0,126,6,126,3,126,5,126,1,126,7,126,2,126,4,126, \
							  0,125,6,125,3,125,5,125,1,125,7,125,2,125,4,125, \
							  0,124,6,124,3,124,5,124
							};

static u8 a_unit2_s2[664] = { 1,124,7,124,2,124,4,124, \
							  0,123,6,123,3,123,5,123,1,123,7,123,2,123,4,123, \
							  0,122,6,122,3,122,5,122,1,122,7,122,2,122,4,122, \
							  0,121,6,121,3,121,5,121,1,121,7,121,2,121,4,121, \
							  0,120,6,120,3,120,5,120,1,120,7,120,2,120,4,120, \
							  0,119,6,119,3,119,5,119,1,119,7,119,2,119,4,119, \
							  0,118,6,118,3,118,5,118,1,118,7,118,2,118,4,118, \
							  0,117,6,117,3,117,5,117,1,117,7,117,2,117,4,117, \
							  0,116,6,116,3,116,5,116,1,116,7,116,2,116,4,116, \
							  0,115,6,115,3,115,5,115,1,115,7,115,2,115,4,115, \
							  0,114,6,114,3,114,5,114,1,114,7,114,2,114,4,114, \
							  0,113,6,113,3,113,5,113,1,113,7,113,2,113,4,113, \
							  0,112,6,112,3,112,5,112,1,112,7,112,2,112,4,112, \
							  0,111,6,111,3,111,5,111,1,111,7,111,2,111,4,111, \
							  0,110,6,110,3,110,5,110,1,110,7,110,2,110,4,110, \
							  0,109,6,109,3,109,5,109,1,109,7,109,2,109,4,109, \
							  0,108,6,108,3,108,5,108,1,108,7,108,2,108,4,108, \
							  0,107,6,107,3,107,5,107,1,107,7,107,2,107,4,107, \
							  0,106,6,106,3,106,5,106,1,106,7,106,2,106,4,106, \
							  0,105,6,105,3,105,5,105,1,105,7,105,2,105,4,105, \
							  0,104,6,104,3,104,5,104,1,104,7,104,2,104,4,104, \
							  0,103,6,103,3,103,5,103,1,103,7,103,2,103,4,103, \
							  0,102,6,102,3,102,5,102,1,102,7,102,2,102,4,102, \
							  0,101,6,101,3,101,5,101,1,101,7,101,2,101,4,101, \
							  0,100,6,100,3,100,5,100,1,100,7,100,2,100,4,100, \
							  0,99,6,99,3,99,5,99,1,99,7,99,2,99,4,99, \
							  0,98,6,98,3,98,5,98,1,98,7,98,2,98,4,98, \
							  0,97,6,97,3,97,5,97,1,97,7,97,2,97,4,97, \
							  0,96,6,96,3,96,5,96,1,96,7,96,2,96,4,96, \
							  0,95,6,95,3,95,5,95,1,95,7,95,2,95,4,95, \
							  0,94,6,94,3,94,5,94,1,94,7,94,2,94,4,94, \
							  0,93,6,93,3,93,5,93,1,93,7,93,2,93,4,93, \
							  0,92,6,92,3,92,5,92,1,92,7,92,2,92,4,92, \
							  0,91,6,91,3,91,5,91,1,91,7,91,2,91,4,91, \
							  0,90,6,90,3,90,5,90,1,90,7,90,2,90,4,90, \
							  0,89,6,89,3,89,5,89,1,89,7,89,2,89,4,89, \
							  0,88,6,88,3,88,5,88,1,88,7,88,2,88,4,88, \
							  0,87,6,87,3,87,5,87,1,87,7,87,2,87,4,87, \
							  0,86,6,86,3,86,5,86,1,86,7,86,2,86,4,86, \
							  0,85,6,85,3,85,5,85,1,85,7,85,2,85,4,85, \
							  0,84,6,84,3,84,5,84,1,84,7,84,2,84,4,84, \
							  0,83,6,83,3,83,5,83,1,83,7,83,2,83,4,83
							};

static u8 b_unit1_s1[664] = { 15,0,9,0,12,0,10,0,14,0,8,0,13,0,11,0, \
   							  15,1,9,1,12,1,10,1,14,1,8,1,13,1,11,1, \
   							  15,2,9,2,12,2,10,2,14,2,8,2,13,2,11,2, \
   							  15,3,9,3,12,3,10,3,14,3,8,3,13,3,11,3, \
   							  15,4,9,4,12,4,10,4,14,4,8,4,13,4,11,4, \
   							  15,5,9,5,12,5,10,5,14,5,8,5,13,5,11,5, \
   							  15,6,9,6,12,6,10,6,14,6,8,6,13,6,11,6, \
   							  15,7,9,7,12,7,10,7,14,7,8,7,13,7,11,7, \
   							  15,8,9,8,12,8,10,8,14,8,8,8,13,8,11,8, \
   							  15,9,9,9,12,9,10,9,14,9,8,9,13,9,11,9, \
   							  15,10,9,10,12,10,10,10,14,10,8,10,13,10,11,10, \
   							  15,11,9,11,12,11,10,11,14,11,8,11,13,11,11,11, \
   							  15,12,9,12,12,12,10,12,14,12,8,12,13,12,11,12, \
   							  15,13,9,13,12,13,10,13,14,13,8,13,13,13,11,13, \
   							  15,14,9,14,12,14,10,14,14,14,8,14,13,14,11,14, \
   							  15,15,9,15,12,15,10,15,14,15,8,15,13,15,11,15, \
   							  15,16,9,16,12,16,10,16,14,16,8,16,13,16,11,16, \
   							  15,17,9,17,12,17,10,17,14,17,8,17,13,17,11,17, \
   							  15,18,9,18,12,18,10,18,14,18,8,18,13,18,11,18, \
   							  15,19,9,19,12,19,10,19,14,19,8,19,13,19,11,19, \
   							  15,20,9,20,12,20,10,20,14,20,8,20,13,20,11,20, \
   							  15,21,9,21,12,21,10,21,14,21,8,21,13,21,11,21, \
   							  15,22,9,22,12,22,10,22,14,22,8,22,13,22,11,22, \
   							  15,23,9,23,12,23,10,23,14,23,8,23,13,23,11,23, \
   							  15,24,9,24,12,24,10,24,14,24,8,24,13,24,11,24, \
   							  15,25,9,25,12,25,10,25,14,25,8,25,13,25,11,25, \
   							  15,26,9,26,12,26,10,26,14,26,8,26,13,26,11,26, \
   							  15,27,9,27,12,27,10,27,14,27,8,27,13,27,11,27, \
   							  15,28,9,28,12,28,10,28,14,28,8,28,13,28,11,28, \
   							  15,29,9,29,12,29,10,29,14,29,8,29,13,29,11,29, \
   							  15,30,9,30,12,30,10,30,14,30,8,30,13,30,11,30, \
   							  15,31,9,31,12,31,10,31,14,31,8,31,13,31,11,31, \
   							  15,32,9,32,12,32,10,32,14,32,8,32,13,32,11,32, \
   							  15,33,9,33,12,33,10,33,14,33,8,33,13,33,11,33, \
   							  15,34,9,34,12,34,10,34,14,34,8,34,13,34,11,34, \
   							  15,35,9,35,12,35,10,35,14,35,8,35,13,35,11,35, \
   							  15,36,9,36,12,36,10,36,14,36,8,36,13,36,11,36, \
   							  15,37,9,37,12,37,10,37,14,37,8,37,13,37,11,37, \
   							  15,38,9,38,12,38,10,38,14,38,8,38,13,38,11,38, \
   							  15,39,9,39,12,39,10,39,14,39,8,39,13,39,11,39, \
   							  15,40,9,40,12,40,10,40,14,40,8,40,13,40,11,40, \
   							  15,41,9,41,12,41,10,41
							};

static u8 b_unit1_s2[664] = { 14,41,8,41,13,41,11,41, \
							  15,42,9,42,12,42,10,42,14,42,8,42,13,42,11,42, \
							  15,43,9,43,12,43,10,43,14,43,8,43,13,43,11,43, \
							  15,44,9,44,12,44,10,44,14,44,8,44,13,44,11,44, \
							  15,45,9,45,12,45,10,45,14,45,8,45,13,45,11,45, \
							  15,46,9,46,12,46,10,46,14,46,8,46,13,46,11,46, \
							  15,47,9,47,12,47,10,47,14,47,8,47,13,47,11,47, \
							  15,48,9,48,12,48,10,48,14,48,8,48,13,48,11,48, \
							  15,49,9,49,12,49,10,49,14,49,8,49,13,49,11,49, \
							  15,50,9,50,12,50,10,50,14,50,8,50,13,50,11,50, \
							  15,51,9,51,12,51,10,51,14,51,8,51,13,51,11,51, \
							  15,52,9,52,12,52,10,52,14,52,8,52,13,52,11,52, \
							  15,53,9,53,12,53,10,53,14,53,8,53,13,53,11,53, \
							  15,54,9,54,12,54,10,54,14,54,8,54,13,54,11,54, \
							  15,55,9,55,12,55,10,55,14,55,8,55,13,55,11,55, \
							  15,56,9,56,12,56,10,56,14,56,8,56,13,56,11,56, \
							  15,57,9,57,12,57,10,57,14,57,8,57,13,57,11,57, \
							  15,58,9,58,12,58,10,58,14,58,8,58,13,58,11,58, \
							  15,59,9,59,12,59,10,59,14,59,8,59,13,59,11,59, \
							  15,60,9,60,12,60,10,60,14,60,8,60,13,60,11,60, \
							  15,61,9,61,12,61,10,61,14,61,8,61,13,61,11,61, \
							  15,62,9,62,12,62,10,62,14,62,8,62,13,62,11,62, \
							  15,63,9,63,12,63,10,63,14,63,8,63,13,63,11,63, \
							  15,64,9,64,12,64,10,64,14,64,8,64,13,64,11,64, \
							  15,65,9,65,12,65,10,65,14,65,8,65,13,65,11,65, \
							  15,66,9,66,12,66,10,66,14,66,8,66,13,66,11,66, \
							  15,67,9,67,12,67,10,67,14,67,8,67,13,67,11,67, \
							  15,68,9,68,12,68,10,68,14,68,8,68,13,68,11,68, \
							  15,69,9,69,12,69,10,69,14,69,8,69,13,69,11,69, \
							  15,70,9,70,12,70,10,70,14,70,8,70,13,70,11,70, \
							  15,71,9,71,12,71,10,71,14,71,8,71,13,71,11,71, \
							  15,72,9,72,12,72,10,72,14,72,8,72,13,72,11,72, \
							  15,73,9,73,12,73,10,73,14,73,8,73,13,73,11,73, \
							  15,74,9,74,12,74,10,74,14,74,8,74,13,74,11,74, \
							  15,75,9,75,12,75,10,75,14,75,8,75,13,75,11,75, \
							  15,76,9,76,12,76,10,76,14,76,8,76,13,76,11,76, \
							  15,77,9,77,12,77,10,77,14,77,8,77,13,77,11,77, \
							  15,78,9,78,12,78,10,78,14,78,8,78,13,78,11,78, \
							  15,79,9,79,12,79,10,79,14,79,8,79,13,79,11,79, \
							  15,80,9,80,12,80,10,80,14,80,8,80,13,80,11,80, \
							  15,81,9,81,12,81,10,81,14,81,8,81,13,81,11,81, \
							  15,82,9,82,12,82,10,82,14,82,8,82,13,82,11,82
							};

static u8 b_unit2_s1[664] = { 15,83,9,83,12,83,10,83,14,83,8,83,13,83,11,83, \
							  15,84,9,84,12,84,10,84,14,84,8,84,13,84,11,84, \
							  15,85,9,85,12,85,10,85,14,85,8,85,13,85,11,85, \
							  15,86,9,86,12,86,10,86,14,86,8,86,13,86,11,86, \
							  15,87,9,87,12,87,10,87,14,87,8,87,13,87,11,87, \
							  15,88,9,88,12,88,10,88,14,88,8,88,13,88,11,88, \
							  15,89,9,89,12,89,10,89,14,89,8,89,13,89,11,89, \
							  15,90,9,90,12,90,10,90,14,90,8,90,13,90,11,90, \
							  15,91,9,91,12,91,10,91,14,91,8,91,13,91,11,91, \
							  15,92,9,92,12,92,10,92,14,92,8,92,13,92,11,92, \
							  15,93,9,93,12,93,10,93,14,93,8,93,13,93,11,93, \
							  15,94,9,94,12,94,10,94,14,94,8,94,13,94,11,94, \
							  15,95,9,95,12,95,10,95,14,95,8,95,13,95,11,95, \
							  15,96,9,96,12,96,10,96,14,96,8,96,13,96,11,96, \
							  15,97,9,97,12,97,10,97,14,97,8,97,13,97,11,97, \
							  15,98,9,98,12,98,10,98,14,98,8,98,13,98,11,98, \
							  15,99,9,99,12,99,10,99,14,99,8,99,13,99,11,99, \
							  15,100,9,100,12,100,10,100,14,100,8,100,13,100,11,100, \
							  15,101,9,101,12,101,10,101,14,101,8,101,13,101,11,101, \
							  15,102,9,102,12,102,10,102,14,102,8,102,13,102,11,102, \
							  15,103,9,103,12,103,10,103,14,103,8,103,13,103,11,103, \
							  15,104,9,104,12,104,10,104,14,104,8,104,13,104,11,104, \
							  15,105,9,105,12,105,10,105,14,105,8,105,13,105,11,105, \
							  15,106,9,106,12,106,10,106,14,106,8,106,13,106,11,106, \
							  15,107,9,107,12,107,10,107,14,107,8,107,13,107,11,107, \
							  15,108,9,108,12,108,10,108,14,108,8,108,13,108,11,108, \
							  15,109,9,109,12,109,10,109,14,109,8,109,13,109,11,109, \
							  15,110,9,110,12,110,10,110,14,110,8,110,13,110,11,110, \
							  15,111,9,111,12,111,10,111,14,111,8,111,13,111,11,111, \
							  15,112,9,112,12,112,10,112,14,112,8,112,13,112,11,112, \
							  15,113,9,113,12,113,10,113,14,113,8,113,13,113,11,113, \
							  15,114,9,114,12,114,10,114,14,114,8,114,13,114,11,114, \
							  15,115,9,115,12,115,10,115,14,115,8,115,13,115,11,115, \
							  15,116,9,116,12,116,10,116,14,116,8,116,13,116,11,116, \
							  15,117,9,117,12,117,10,117,14,117,8,117,13,117,11,117, \
							  15,118,9,118,12,118,10,118,14,118,8,118,13,118,11,118, \
							  15,119,9,119,12,119,10,119,14,119,8,119,13,119,11,119, \
							  15,120,9,120,12,120,10,120,14,120,8,120,13,120,11,120, \
							  15,121,9,121,12,121,10,121,14,121,8,121,13,121,11,121, \
							  15,122,9,122,12,122,10,122,14,122,8,122,13,122,11,122, \
							  15,123,9,123,12,123,10,123,14,123,8,123,13,123,11,123, \
							  14,124,8,124,13,124,11,124
							};

static u8 b_unit2_s2[664] = { 14,124,8,124,13,124,11,124, \
							  15,125,9,125,12,125,10,125,14,125,8,125,13,125,11,125, \
							  15,126,9,126,12,126,10,126,14,126,8,126,13,126,11,126, \
							  15,127,9,127,12,127,10,127,14,127,8,127,13,127,11,127, \
							  15,128,9,128,12,128,10,128,14,128,8,128,13,128,11,128, \
							  15,129,9,129,12,129,10,129,14,129,8,129,13,129,11,129, \
							  15,130,9,130,12,130,10,130,14,130,8,130,13,130,11,130, \
							  15,131,9,131,12,131,10,131,14,131,8,131,13,131,11,131, \
							  15,132,9,132,12,132,10,132,14,132,8,132,13,132,11,132, \
							  15,133,9,133,12,133,10,133,14,133,8,133,13,133,11,133, \
							  15,134,9,134,12,134,10,134,14,134,8,134,13,134,11,134, \
							  15,135,9,135,12,135,10,135,14,135,8,135,13,135,11,135, \
							  15,136,9,136,12,136,10,136,14,136,8,136,13,136,11,136, \
							  15,137,9,137,12,137,10,137,14,137,8,137,13,137,11,137, \
							  15,138,9,138,12,138,10,138,14,138,8,138,13,138,11,138, \
							  15,139,9,139,12,139,10,139,14,139,8,139,13,139,11,139, \
							  15,140,9,140,12,140,10,140,14,140,8,140,13,140,11,140, \
							  15,141,9,141,12,141,10,141,14,141,8,141,13,141,11,141, \
							  15,142,9,142,12,142,10,142,14,142,8,142,13,142,11,142, \
							  15,143,9,143,12,143,10,143,14,143,8,143,13,143,11,143, \
							  15,144,9,144,12,144,10,144,14,144,8,144,13,144,11,144, \
							  15,145,9,145,12,145,10,145,14,145,8,145,13,145,11,145, \
							  15,146,9,146,12,146,10,146,14,146,8,146,13,146,11,146, \
							  15,147,9,147,12,147,10,147,14,147,8,147,13,147,11,147, \
							  15,148,9,148,12,148,10,148,14,148,8,148,13,148,11,148, \
							  15,149,9,149,12,149,10,149,14,149,8,149,13,149,11,149, \
							  15,150,9,150,12,150,10,150,14,150,8,150,13,150,11,150, \
							  15,151,9,151,12,151,10,151,14,151,8,151,13,151,11,151, \
							  15,152,9,152,12,152,10,152,14,152,8,152,13,152,11,152, \
							  15,153,9,153,12,153,10,153,14,153,8,153,13,153,11,153, \
							  15,154,9,154,12,154,10,154,14,154,8,154,13,154,11,154, \
							  15,155,9,155,12,155,10,155,14,155,8,155,13,155,11,155, \
							  15,156,9,156,12,156,10,156,14,156,8,156,13,156,11,156, \
							  15,157,9,157,12,157,10,157,14,157,8,157,13,157,11,157, \
							  15,158,9,158,12,158,10,158,14,158,8,158,13,158,11,158, \
							  15,159,9,159,12,159,10,159,14,159,8,159,13,159,11,159, \
							  15,160,9,160,12,160,10,160,14,160,8,160,13,160,11,160, \
							  15,161,9,161,12,161,10,161,14,161,8,161,13,161,11,161, \
							  15,162,9,162,12,162,10,162,14,162,8,162,13,162,11,162, \
							  15,163,9,163,12,163,10,163,14,163,8,163,13,163,11,163, \
							  15,164,9,164,12,164,10,164,14,164,8,164,13,164,11,164, \
							  15,165,9,165,12,165,10,165,14,165,8,165,13,165,11,165
							};

static u8 *sins[8] ={a_unit1_s1, a_unit1_s2, a_unit2_s1, a_unit2_s2,
					b_unit1_s1, b_unit1_s2, b_unit2_s1, b_unit2_s2};

//#define _IOC_F2SM_START 0x0501
//#define _IOC_F2SM_STOP  0x0502
//#define _IOC_F2SM_PAUSE 0x0503
//#define _IOC_F2SM_DQBUF 0x0504

#define _IOC_F2SM_START _IO(0x05, 0x01)
#define _IOC_F2SM_STOP  _IO(0x05, 0x02)
#define _IOC_F2SM_PAUSE _IO(0x05, 0x03)
#define _IOC_F2SM_DQBUF _IO(0x05, 0x04)


int main(void)
{
	
	CYxmIntf yxm;

   	yxm.Init();
	

	/* 构造和预先检查数据 */
	int ret;
	int the_fd = yxm.m_fd;
	u32 block_size = TEST_BLOCK_SIZE;
	u32 block_cnt = TEST_BLOCK_CNT;	
	u8 *ph0_data = (u8 *)malloc(2 * PH1_USERBUF_OFFSET);
	u8 *ph1_data = ph0_data + PH1_USERBUF_OFFSET;

	/* 每个喷头3m有效数据，但是每个喷头buffer 12m空间 */
	ret = build_fpga_data(ph0_data, ph1_data, block_size, block_cnt);
	if (ret == -1) {
		fprintf(stderr, "Build Data Error at line %d, file %s\n", __LINE__, __FILE__);
		return -1;
	}
	
	ret = check_fpga_data(ph0_data, ph1_data, block_size, block_cnt);
	if (ret == -1) {
		fprintf(stderr, "Check Data Error at line %d, file %s\n", __LINE__, __FILE__);
		return -1;
	}	

	yxm.Step1();
 
	/* 启动一次上行传输 */
	yxm.StartTransfer_up(0, 1);

	yxm.Step2();

	yxm.Step3();

	/* step4 */
	pid_t pid;
	pid = fork();
	if (pid == 0) {		/* 下行子进程 ioctl write StartTransfer_down close */
		/* 下行DMA数据传输，收到中断则继续发送，直到所有数据发送完成 */
		int down_i = 0;
		int down_times = block_cnt;	
		u32 down_blk_size = block_size;

		for ( ; down_i < down_times; down_i++) {
	
			ret = ioctl(the_fd, _IOC_F2SM_DQBUF, 0);
			if (ret < 0) {
				fprintf(stderr, "Ioctl Error at line %d, file %s\n", __LINE__, __FILE__);
				yxm.Close();
				exit(-1);
			} else if (ret == 1) {
				printf("normal stop\n");
				yxm.Close();
				exit(0);
			} else if (ret == 2) {
				fprintf(stderr, "accident stop\n");
				yxm.Close();
				exit(-1);
			}

			ret = write(the_fd, ph0_data + down_i * down_blk_size, down_blk_size);
			if (ret != down_blk_size) {
				printf("first write error\n");
				return -1;		
			}

			yxm.StartTransfer_down(1, 1);
		
		}	
		printf("data send done\n");
		yxm.Close();
		exit(0);
		
	} else if (pid > 0) {	/* 上行主进程 read StartTransfer_up waitpid */
		
		yxm.StartPrint();
		
		/* 打印过程持续检测上行DMA中断。每次收到中断则启动下次一数据传输(配置数据块大小,地址6写1写0)
		 * 此过程软件不需要主动结束，有中断上来就一直配置传输
		 * 打印过程中持续检测硬件中断bit[5]和bit[4]。收到硬件中断bit[4]表示打印正常结束/收到硬件
		 * 中断bit[5]表示打印异常停止。打印输出寄存器内容,测试结束
		 */
		u32 up_blksize = block_size/3;	//1kb
		u8 *up_buf = (u8 *)malloc(up_blksize * 2);	//2 ph each 1kb,so total 2kb
		u8 *loop_back_data = (u8 *)malloc(2 * PH1_USERBUF_OFFSET);
		u32 out_loop_back_i;	//收到的第几个1kb
		u32 in_loop_back_i;		//332
		u32 in_in_loop_back_i;	//8
		u32 which_threek;	//收到4个kb对应一个3kb,因为多余数据
		u32 which_onek;		//对应3kb中的喷孔的第几次点火
		for (out_loop_back_i = 0; ; out_loop_back_i++) {
			ret = read(the_fd, up_buf, up_blksize * 2);
			if (ret != up_blksize) {
				if (ret == 1) {
					printf("normal stop\n");
					free(up_buf);
					goto loop_skit;
				} else if (ret == 2) {
					fprintf(stderr, "accident stop\n");
					free(up_buf);
					goto loop_skit;
				} else {
					fprintf(stderr, "Error at line %d, file %s\n", __LINE__, __FILE__);
					free(up_buf);
					free(loop_back_data);					
					yxm.Close();
					exit(-1);
				}
				
			} 

			which_threek = out_loop_back_i / 4;
			which_onek = out_loop_back_i & 0x3;

			/* 塞数据回大loop_back_data */
			u16 *tmp_src;
			u8 *tmp_dst;
			u8 tmp_dst_2bit;
			u8 *which_sin;
			u8 line;
			u8 row;
			
			for (in_loop_back_i = 0; in_loop_back_i < 332; in_loop_back_i++) {
				
				/* ph0 */
				tmp_src = (u16 *)(up_buf + in_loop_back_i*2);
				for (in_in_loop_back_i = 0; in_in_loop_back_i < 8; in_in_loop_back_i++) {
					which_sin = sins[in_in_loop_back_i];
					line = which_sin[in_loop_back_i*2];
					row = which_sin[in_loop_back_i*2 + 1];
					
					tmp_dst = loop_back_data + which_threek * 3 * 1024 + row * 16 + line;
					
					*tmp_dst &= ~(0x3 << 2*which_onek);			//mask the field
					tmp_dst_2bit = (u8)(*tmp_src >> 2*in_in_loop_back_i);
					tmp_dst_2bit &= 0x3;
					tmp_dst_2bit <<= 2*which_onek; 
					*tmp_dst |= tmp_dst_2bit;					//fill the field	
				}
				
				/* ph1 */
				tmp_src = (u16 *)(up_buf + up_blksize + in_loop_back_i*2);
				for (in_in_loop_back_i = 0; in_in_loop_back_i < 8; in_in_loop_back_i++) {
					which_sin = sins[in_in_loop_back_i];
					line = which_sin[in_loop_back_i*2];
					row = which_sin[in_loop_back_i*2 + 1];

					tmp_dst = loop_back_data + PH1_USERBUF_OFFSET + which_threek * 3 * 1024 + row * 16 + line;

					*tmp_dst &= ~(0x3 << 2*which_onek);			//mask the field
					tmp_dst_2bit = (u8)(*tmp_src >> 2*in_in_loop_back_i);
					tmp_dst_2bit &= 0x3;
					tmp_dst_2bit <<= 2*which_onek; 
					*tmp_dst |= tmp_dst_2bit;					//fill the field					
				}
			}
			
			yxm.StartTransfer_up(0, 1);

		}

		
		/* TODO:拉偏置和效验 */
		
loop_skit:
	    /* 打印寄存器
	     * 结束打印
		 */
		free(loop_back_data);
		yxm.PrintRegs();
		yxm.FinishPrint();			
		yxm.Close();	
		waitpid(pid, NULL, 0);	
		
	} else {
		fprintf(stderr, "Fork Error at line %d, file %s\n", __LINE__, __FILE__);
		return -1;
	}
	
	
	return 0;
}


